# DB 스키마 설계

## 🎯 목표
기존 MySQL 스키마를 PostgreSQL + JPA에 맞게 재설계한다.

---

## 📋 개요

| 항목 | 기존 | 신규 |
|------|------|------|
| Database | MySQL 8.x | PostgreSQL 15+ (Neon) |
| ORM | MyBatis | JPA (Hibernate) |
| 명명규칙 | snake_case 혼용 | snake_case 통일 |

---

## 📊 ERD 개요

```
┌─────────────┐     ┌─────────────┐
│   members   │────<│  restaurants │
└─────────────┘     └─────────────┘
       │                    │
       │                    │
       ▼                    ▼
┌─────────────┐     ┌─────────────┐
│   reviews   │     │    menus    │
└─────────────┘     └─────────────┘
       │
       ▼
┌─────────────┐
│review_images│
└─────────────┘

┌─────────────┐     ┌─────────────┐
│   members   │────<│ reservations│
└─────────────┘     └─────────────┘

┌─────────────┐
│   follows   │ (members ↔ members, members ↔ restaurants)
└─────────────┘
```

---

## 🗃️ 테이블 설계

### 1. members (회원)

```sql
CREATE TABLE members (
    id              BIGSERIAL PRIMARY KEY,
    email           VARCHAR(255) NOT NULL UNIQUE,
    password        VARCHAR(255) NOT NULL,
    name            VARCHAR(100) NOT NULL,
    nickname        VARCHAR(50) NOT NULL UNIQUE,
    phone           VARCHAR(20),
    zipcode         VARCHAR(10),
    address         VARCHAR(255),
    address_detail  VARCHAR(255),
    birth_date      DATE,
    profile_image   VARCHAR(500),
    role            VARCHAR(20) NOT NULL DEFAULT 'USER',
    business_number VARCHAR(20),
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at      TIMESTAMP,
    
    CONSTRAINT chk_role CHECK (role IN ('USER', 'BUSINESS', 'ADMIN'))
);

CREATE INDEX idx_members_email ON members(email);
CREATE INDEX idx_members_nickname ON members(nickname);
CREATE INDEX idx_members_role ON members(role);
```

**변경사항**:
- `userid` → `email` (이메일 로그인)
- `tel` → `phone`
- `addr1/addr2` → `address/address_detail`
- `buisness` → `business_number`
- `role` 타입을 ENUM 대신 VARCHAR + CHECK
- soft delete를 위한 `deleted_at` 추가

---

### 2. restaurants (식당)

```sql
CREATE TABLE restaurants (
    id              BIGSERIAL PRIMARY KEY,
    owner_id        BIGINT NOT NULL REFERENCES members(id),
    name            VARCHAR(200) NOT NULL,
    category        VARCHAR(50) NOT NULL,
    description     TEXT,
    phone           VARCHAR(20),
    zipcode         VARCHAR(10),
    address         VARCHAR(255) NOT NULL,
    address_detail  VARCHAR(255),
    latitude        DECIMAL(10, 8),
    longitude       DECIMAL(11, 8),
    website         VARCHAR(500),
    business_hours  VARCHAR(500),
    notice          TEXT,
    thumbnail       VARCHAR(500),
    menu_board_image VARCHAR(500),
    avg_rating      DECIMAL(3, 2) DEFAULT 0,
    review_count    INTEGER DEFAULT 0,
    view_count      INTEGER DEFAULT 0,
    status          VARCHAR(20) DEFAULT 'ACTIVE',
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_status CHECK (status IN ('ACTIVE', 'INACTIVE', 'DELETED'))
);

CREATE INDEX idx_restaurants_owner ON restaurants(owner_id);
CREATE INDEX idx_restaurants_category ON restaurants(category);
CREATE INDEX idx_restaurants_status ON restaurants(status);
CREATE INDEX idx_restaurants_location ON restaurants(latitude, longitude);
```

**변경사항**:
- `business` → `owner_id` (FK)
- `r_name` → `name` (prefix 제거)
- `r_code` 제거 (불필요)
- `r_intro` → `description`
- `r_time` → `business_hours`
- 위치 정보 (`latitude`, `longitude`) 추가
- 통계 필드 (`avg_rating`, `review_count`, `view_count`) 추가
- `status` 추가

---

### 3. menus (메뉴)

```sql
CREATE TABLE menus (
    id              BIGSERIAL PRIMARY KEY,
    restaurant_id   BIGINT NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    name            VARCHAR(200) NOT NULL,
    price           INTEGER NOT NULL,
    description     TEXT,
    thumbnail       VARCHAR(500),
    is_visible      BOOLEAN DEFAULT true,
    sort_order      INTEGER DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_menus_restaurant ON menus(restaurant_id);
CREATE INDEX idx_menus_visible ON menus(is_visible);
```

**변경사항**:
- `business` → `restaurant_id` (FK)
- `m_name` → `name`
- `m_cost` → `price` (INTEGER)
- `m_intro` → `description`
- `visible` → `is_visible` (BOOLEAN)
- `sort_order` 추가

---

### 4. reviews (리뷰)

```sql
CREATE TABLE reviews (
    id              BIGSERIAL PRIMARY KEY,
    restaurant_id   BIGINT NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    member_id       BIGINT NOT NULL REFERENCES members(id),
    title           VARCHAR(200),
    content         TEXT NOT NULL,
    rating          INTEGER NOT NULL,
    view_count      INTEGER DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_rating CHECK (rating >= 1 AND rating <= 5)
);

CREATE INDEX idx_reviews_restaurant ON reviews(restaurant_id);
CREATE INDEX idx_reviews_member ON reviews(member_id);
CREATE INDEX idx_reviews_rating ON reviews(rating);
CREATE INDEX idx_reviews_created ON reviews(created_at DESC);
```

---

### 5. review_images (리뷰 이미지)

```sql
CREATE TABLE review_images (
    id              BIGSERIAL PRIMARY KEY,
    review_id       BIGINT NOT NULL REFERENCES reviews(id) ON DELETE CASCADE,
    image_url       VARCHAR(500) NOT NULL,
    sort_order      INTEGER DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_review_images_review ON review_images(review_id);
```

---

### 6. reservations (예약)

```sql
CREATE TABLE reservations (
    id              BIGSERIAL PRIMARY KEY,
    restaurant_id   BIGINT NOT NULL REFERENCES restaurants(id),
    member_id       BIGINT NOT NULL REFERENCES members(id),
    guest_count     INTEGER NOT NULL,
    reservation_date DATE NOT NULL,
    reservation_time TIME NOT NULL,
    request         TEXT,
    status          VARCHAR(20) DEFAULT 'PENDING',
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_reservation_status CHECK (status IN ('PENDING', 'CONFIRMED', 'CANCELLED', 'COMPLETED'))
);

CREATE INDEX idx_reservations_restaurant ON reservations(restaurant_id);
CREATE INDEX idx_reservations_member ON reservations(member_id);
CREATE INDEX idx_reservations_date ON reservations(reservation_date);
CREATE INDEX idx_reservations_status ON reservations(status);
```

**변경사항**:
- 기존 필드를 FK 기반으로 정규화
- `resNum` → `guest_count`
- `resDay` → `reservation_date`
- `resTime` → `reservation_time`
- `status` 추가

---

### 7. follows (팔로우)

```sql
CREATE TABLE follows (
    id              BIGSERIAL PRIMARY KEY,
    follower_id     BIGINT NOT NULL REFERENCES members(id) ON DELETE CASCADE,
    following_id    BIGINT REFERENCES members(id) ON DELETE CASCADE,
    restaurant_id   BIGINT REFERENCES restaurants(id) ON DELETE CASCADE,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT chk_follow_target CHECK (
        (following_id IS NOT NULL AND restaurant_id IS NULL) OR
        (following_id IS NULL AND restaurant_id IS NOT NULL)
    ),
    CONSTRAINT uq_follow UNIQUE (follower_id, following_id, restaurant_id)
);

CREATE INDEX idx_follows_follower ON follows(follower_id);
CREATE INDEX idx_follows_following ON follows(following_id);
CREATE INDEX idx_follows_restaurant ON follows(restaurant_id);
```

**설명**:
- 회원 팔로우: `follower_id` → `following_id`
- 식당 팔로우(찜): `follower_id` → `restaurant_id`

---

### 8. files (파일 관리) - 선택적

```sql
CREATE TABLE files (
    id              BIGSERIAL PRIMARY KEY,
    original_name   VARCHAR(255) NOT NULL,
    stored_name     VARCHAR(255) NOT NULL,
    file_path       VARCHAR(500) NOT NULL,
    file_size       BIGINT,
    content_type    VARCHAR(100),
    entity_type     VARCHAR(50) NOT NULL,
    entity_id       BIGINT NOT NULL,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_files_entity ON files(entity_type, entity_id);
```

---

## 🔄 마이그레이션 매핑

| 기존 (MySQL) | 신규 (PostgreSQL) | 비고 |
|--------------|-------------------|------|
| member | members | 복수형 |
| restaurant | restaurants | 복수형 |
| menu | menus | 복수형 |
| review | reviews | 복수형 |
| reservation | reservations | 신규 테이블 |
| follow | follows | 구조 변경 |

---

## 📝 JPA Entity 명명규칙

### Entity Class
```java
@Entity
@Table(name = "members")
public class Member {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true)
    private String email;
    
    // ...
}
```

### Repository
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
    Optional<Member> findByEmail(String email);
}
```

---

## ⚠️ 주의사항

1. **PostgreSQL 특성**
   - `SERIAL` 대신 `BIGSERIAL` 사용
   - `BOOLEAN` 타입 지원
   - `TEXT` 타입 성능 좋음

2. **인덱스**
   - 자주 검색되는 컬럼에 인덱스
   - FK는 자동 인덱스 생성 안됨 (수동 추가)

3. **Soft Delete**
   - `deleted_at` 컬럼으로 구현
   - JPA `@Where` 어노테이션 활용

---

## 🔗 관련 문서

- [[01_Phase1_인프라설정]]
- [[02_Phase2_백엔드핵심]]
- [[08_API명세서]]
- [[project_context]]

